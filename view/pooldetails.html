<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/dashboard.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>Erkport</title>
</head>

<body>

    <div class="container-fluid py-2">
        <div class="row d-flex">

            <div class="container col-sm-12 col-md-3 col-xl-2 mb-sm-5 nav-div">

                <nav>
                    <div class="container-fluid">
                        <div class="navbar-brand col-12">
                            <img src="/static/image/erk.png" class="w-100" alt="arkas logo">
                        </div>

                        <hr>

                        <div class="container-fluid">
                            <ul class="menu-links my-2 p-2 col-12">
                                <li class="nav-item">
                                    <a class="nav-link" href="./">DASHBOARD</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./ets.html">ETS</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./cii.html">CII</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./fuel_eu.html">FUEL EU</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./input.html">INPUT</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./pool.html">POOL</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="./pooldetails.html">POOL DETAILS</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="logout-button-div">
                        <button class="btn btn-danger logout-button fw-bold col-12">Logout</button>
                    </div>

                </nav>
            </div>

            <div class="container-fluid col-sm-12 col-md-9 col-xl-10 mt-sm-2 mt-md-2 pt-3 px-4">

                <div class="container header-and-button">
                    <div class="header">
                        <h2 class="h2 fw-bold mx-sm-3 mx-xl-4 my-3">Pool Details</h2>
                    </div>
                    <div class="downland-pdf-button-div">
                        <button class="btn btn-outline-success">Export to Excel</button>
                    </div>
                </div>




                <div class="table-responsive mt-4">
                    <table id="poolTable" class="table table-warning">
                        <thead>
                            <tr>
                                <th>Pool Name</th>
                                <th>Total Compliance Balance</th>
                                <th>Action</th> <!-- Delete button for action -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
    
                <div class="table-responsive mt-4">
                    <table id="poolDetailTable" class="table table-warning " style="display:none; max-height: 440px; overflow-y: auto;">
                        <thead>
                            <tr>
                                <th>Vessel Name</th>
                                <th>Voyage Repetition Count</th>
                                <th>Leg Status</th>
                                <th>Current Leg</th>
                                <th>Total Distance</th>
                                <th>ECA Distance</th>
                                <th>Sea Fuel Consumption</th>
                                <th>ECA Fuel Consumption</th>
                                <th>Port Fuel Consumption</th>
                                <th>ETS</th>
                                <th>Compliance Balance</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="poolDetailBody">
                            <!-- Pool details will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </main>
        </section>
    
    <!-- JavaScript Section -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPoolName = null;  // Toggle for showing/hiding pool details

        // Fetch and display pool summary
        async function fetchPoolSummary() {
            try {
                const response = await fetch('/get-pool-summary');
                const data = await response.json();

                const tableBody = document.querySelector('#poolTable tbody');
                tableBody.innerHTML = '';  // Clear previous table data

                data.forEach(pool => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="pool-name" data-pool="${pool.pool_name}" style="cursor:pointer">${pool.pool_name}</td>
                        <td>${pool.total_compliance_balance}</td>
                        <td>
                            <button class="btn btn-danger delete-btn" data-pool="${pool.pool_name}">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });

                // Event listeners for showing details and deleting pools
                addEventListeners();
            } catch (error) {
                console.error('Error fetching pool summary:', error);
            }
        }

        // Add event listeners for showing details and deleting pools
        function addEventListeners() {
            // Toggle showing/hiding pool details
            const poolNames = document.querySelectorAll('.pool-name');
            poolNames.forEach(poolNameElement => {
                poolNameElement.addEventListener('click', async function() {
                    const poolName = this.getAttribute('data-pool');
                    if (currentPoolName === poolName) {
                        // Eğer aynı pool tıklanırsa tabloyu gizle
                        document.getElementById('poolDetailTable').style.display = 'none';
                        currentPoolName = null;
                    } else {
                        await fetchPoolDetails(poolName);
                        currentPoolName = poolName;
                    }
                });
            });

            // Delete functionality
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(deleteButton => {
                deleteButton.addEventListener('click', async function() {
                    const poolName = this.getAttribute('data-pool');
                    if (confirm(`Are you sure you want to delete pool "${poolName}"?`)) {
                        try {
                            const deleteResponse = await fetch(`/delete-pool/${poolName}`, { method: 'DELETE' });
                            if (deleteResponse.ok) {
                                alert('Pool deleted successfully');
                                fetchPoolSummary();  // Refresh the table after deletion
                            } else {
                                alert('Failed to delete pool');
                            }
                        } catch (error) {
                            console.error('Error deleting pool:', error);
                            alert('An error occurred while deleting the pool');
                        }
                    }
                });
            });
        }

        // Fetch and display pool details for a specific pool name
        async function fetchPoolDetails(poolName) {
            try {
                const response = await fetch(`/get-pool-details/${poolName}`);
                const data = await response.json();

                const tableBody = document.querySelector('#poolDetailBody');
                tableBody.innerHTML = '';  // Clear previous details

                data.forEach(detail => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${detail.vessel_name}</td>
                        <td>${detail.sefer_tekrar_sayisi}</td>
                        <td>${detail.leg_durumu}</td>
                        <td>${detail.current_leg}</td>
                        <td>${detail.total_distance}</td>
                        <td>${detail.eca_distance}</td>
                        <td>${detail.sea_fuel_consumption}</td>
                        <td>${detail.eca_fuel_consumption}</td>
                        <td>${detail.port_fuel_consumption}</td>
                        <td>${detail.ets}</td>
                        <td>${detail.compliance_balance}</td>
                        <td>${detail.created_at}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                // Show pool detail table
                document.getElementById('poolDetailTable').style.display = 'table';
            } catch (error) {
                console.error('Error fetching pool details:', error);
            }
        }

        // Fetch pool summary on page load
        window.onload = fetchPoolSummary;

            </script>
</body>
</html>
