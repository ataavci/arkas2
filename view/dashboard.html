<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="/static/image/favicon-16x16.png" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style2.css">
</head>
<body>
    <!-- SIDEBAR -->
    <section id="sidebar" class="sidebar bg-light">
        <a href="#" class="brand">
            <i class='bx bxs-smile'></i>
            <span class="text">Dashboard</span>
        </a>
        <ul class="side-menu top">
            <li class="active">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Optimizasyon
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="./dashboard.html">DASHBOARD</a></li>
                    <li><a class="dropdown-item" href="./ets.html">ETS</a></li>
                    <li><a class="dropdown-item" href="./cii.html">CII</a></li>
                    <li><a class="dropdown-item" href="./fuel_eu.html">FUEL EU</a></li>
                    <li><a class="dropdown-item" href="./input.html">ADD VESSEL</a></li>
                </ul>
            </li>
        </ul>
    </section>

    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content-dashboard" class="content">
        <!-- MAIN -->
        <main>
            <div class="head-title">
                <h1>Dashboard</h1>
                <ul class="breadcrumb">
                    <li><a href="#">Dashboard</a></li>
                    <li><i class='bx bx-chevron-right'></i></li>
                </ul>
                <a href="#" class="btn btn-primary btn-download">
                    <i class='bx bxs-cloud-download'></i>
                    Download PDF
                </a>
            </div>

            <!-- Stats Section -->
            <div class="stats-container row">
                <div class="col-md-2 stat-card text-center">
                    <h3>Toplam T端ketim</h3>
                    <p id="total-consumption-value">Y端kleniyor...</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>Complian Balance</h3>
                    <p id="complian-balance-value">Y端kleniyor...</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>GHG Intensity</h3>
                    <p id="ghg_intensity-value">Y端kleniyor...</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>FuelEU Cost</h3>
                    <p>12,152</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>ETS Cost</h3>
                    <p>94,127</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>Total Cost</h3>
                    <p>168,540</p>
                </div>
            </div>

            <!-- Vessel Data Table -->
            <div class="vessel-table-container mt-4">
                <h2>All Vessels</h2>
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Vessel Name</th>
                            <th>Sea Fuel</th>
                            <th>Sea Consumption</th>
                            <th>ECA Fuel</th>
                            <th>ECA Consumption</th>
                            <th>Port Fuel</th>
                            <th>Port Consumption</th>
                            <th>CII Rating</th>
                        </tr>
                    </thead>
                    <tbody id="vessel-table-body">
                        <!-- Dynamic data will load here -->
                    </tbody>
                </table>
            </div>

            <!-- Line Chart (Chart.js) -->
            <section id="content-dashboard" class="content">
                <main>
                    <div class="head-title">
                        <h1>ETS Dashboard</h1>
                    </div>

                    <!-- Chart Containers -->
                    <div class="chart-row">
                        <div class="chart-box chart-container">
                            <canvas id="myLineChart1"></canvas>
                        </div>
                        <div class="chart-box chart-container">
                            <canvas id="myLineChart2"></canvas>
                        </div>
                    </div>
                </main>
            </section>

            <!-- JavaScript Section -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <script>
                let chart1Instance, chart2Instance;

                // Chart 1: Monthly ETS data
                function createLineChart1(labels, data, label) {
                    const ctx = document.getElementById('myLineChart1').getContext('2d');
                    if (chart1Instance) {
                        chart1Instance.destroy(); // Destroy the old chart
                    }

                    chart1Instance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: data,
                                fill: false,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                // Chart 2: ETS data by vessel
                function createLineChart2(dataSets, months) {
                    const ctx = document.getElementById('myLineChart2').getContext('2d');
                    if (chart2Instance) {
                        chart2Instance.destroy(); // Destroy the old chart
                    }

                    chart2Instance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months, // X-axis will show the months
                            datasets: dataSets // Dataset for vessels
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                // Initial state on window load
                window.onload = async function() {
                    try {
                        // Fetch initial data and update charts
                        const defaultLabels = ['January', 'February', 'March', 'April', 'May', 'June', 'July'];
                        const defaultData = [0, 0, 0, 0, 0, 0, 0];
                        createLineChart1(defaultLabels, defaultData, 'Monthly ETS');
                        createLineChart2([], defaultLabels);

                        // Fetch data to update content
                        await fetchTotalConsumption();
                        await fetchComplianBalance();
                        await fetchghgintensity();
                        await fetchVesselData();
                        await fetchChart1Data();
                        await fetchChart2Data();
                    } catch (error) {
                        console.error('Error initializing dashboard:', error);
                    }
                };

                // Fetch and update Total Consumption
                async function fetchTotalConsumption() {
                    try {
                        const response = await fetch('/api/total-consumption');
                        const data = await response.json();
                        console.log("Total Consumption Data: ", data);  // Log the data for debugging
                        document.getElementById('total-consumption-value').textContent = data.totalConsumption || 'No data';
                    } catch (error) {
                        console.error('Error fetching total consumption data:', error);
                    }
                }

                // Fetch and update Complian Balance
                async function fetchComplianBalance() {
                    try {
                        const response = await fetch('/api/complian-balance');
                        const data = await response.json();
                        console.log("Complian Balance Data: ", data);  // Log the data for debugging
                        document.getElementById('complian-balance-value').textContent = data.complianBalance || 'No data';
                    } catch (error) {
                        console.error('Error fetching complian balance data:', error);
                    }
                }

                // Fetch and update GHG Intensity
                async function fetchghgintensity() {
                    try {
                        const response = await fetch('/api/ghg_intensity');
                        const data = await response.json();
                        console.log("GHG Intensity Data: ", data);  // Log the data for debugging
                        document.getElementById('ghg_intensity-value').textContent = data.GHG_intensity || 'No data';
                    } catch (error) {
                        console.error('Error fetching GHG intensity data:', error);
                    }
                }

                // Fetch and update Vessel Data
                async function fetchVesselData() {
                    try {
                        const response = await fetch('/api/vessels');  // Fetch data from API
                        const vessels = await response.json();  // Parse JSON data
                        console.log("Vessel Data: ", vessels);  // Log the data for debugging

                        const tableBody = document.getElementById('vessel-table-body');
                        tableBody.innerHTML = '';  // Clear existing rows

                        vessels.forEach(vessel => {
                            const row = document.createElement('tr');
                            const ciiRating = vessel.CII ? vessel.CII.toLowerCase() : 'n/a';
                            row.innerHTML = `
                                <td>${vessel.vessel_name}</td>
                                <td>${vessel.sea_fuel}</td>
                                <td>${vessel.sea_consumption}</td>
                                <td>${vessel.eca_fuel}</td>
                                <td>${vessel.eca_consumption}</td>
                                <td>${vessel.port_fuel}</td>
                                <td>${vessel.port_consumption}</td>
                                <td><span class="cii-rating ${ciiRating}">${vessel.CII || 'N/A'}</span></td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } catch (error) {
                        console.error('Error fetching vessel data:', error);
                    }
                }

                // Fetch and update Chart 1 data
                async function fetchChart1Data() {
                    try {
                        const response = await fetch('/api/get-data');
                        const data = await response.json();
                        console.log("Chart 1 Data: ", data);  // Log the data for debugging

                        const labels = data.map(item => item.month_name);
                        const values = data.map(item => item.total_ets);

                        createLineChart1(labels, values, 'Monthly ETS');
                    } catch (error) {
                        console.error('Error fetching data for Chart 1:', error);
                    }
                }

                // Fetch and update Chart 2 data
                  // Fetch and update Chart 2 data
    // Fetch and update Chart 2 data
    async function fetchChart2Data() {
    try {
        const response = await fetch('/api/get-vessel-data2');  // Fetch the updated data with vessel, month, and total ETS
        const data = await response.json();
        
        // Log the full API response to inspect the fields
        console.log("Full API Response: ", data);
        
        // Extract unique months from the response
        const months = [...new Set(data.map(item => item.month_name))];  
        const vesselNames = [...new Set(data.map(item => item.vessel_name))];

        console.log("Unique Months:", months);
        console.log("Unique Vessel Names:", vesselNames);

        // Build the dataset for each vessel across the months
        const datasets = vesselNames.map(vessel => {
            const vesselData = months.map(month => {
                // Filter the data for the current vessel and month
                const monthData = data.filter(item => item.vessel_name === vessel && item.month_name === month);
                return monthData.length > 0 ? monthData[0].total_ets : 0;  // Use total_ets from the API response
            });

            // Generate random color for each vessel line
            const randomColor = `rgb(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)})`;

            return {
                label: `Vessel ${vessel}`,  // Label for the vessel
                data: vesselData,  // Data for each month
                fill: false,
                borderColor: randomColor,
                tension: 0.1
            };
        });

        console.log("Datasets for Chart 2:", datasets);

        // Create the line chart for vessels with data across months
        createLineChart2(datasets, months);
    } catch (error) {
        console.error('Error fetching data for Chart 2:', error);
    }
}

// Function to create Line Chart 2 (ETS by vessel per month)
function createLineChart2(dataSets, months) {
    const ctx = document.getElementById('myLineChart2').getContext('2d');
    if (chart2Instance) {
        chart2Instance.destroy(); // Destroy the old chart
    }

    chart2Instance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,  // X-axis will show the months
            datasets: dataSets  // Dataset for vessels
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true  // Start Y-axis at zero
                }
            }
        }
    });
}

            </script>
</body>
</html>
