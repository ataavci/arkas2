<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="/static/image/favicon-16x16.png" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style2.css">
</head>
<body>
    <!-- SIDEBAR -->
    <section id="sidebar" class="sidebar bg-light">
        <a href="#" class="brand">
            <i class='bx bxs-smile'></i>
            <span class="text">Dashboard</span>
        </a>
        <ul class="side-menu top">
            <li class="active">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Optimizasyon
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="./dashboard.html">DASHBOARD</a></li>
                    <li><a class="dropdown-item" href="./ets.html">ETS</a></li>
                    <li><a class="dropdown-item" href="./cii.html">CII</a></li>
                    <li><a class="dropdown-item" href="./fuel_eu.html">FUEL EU</a></li>
                    <li><a class="dropdown-item" href="./input.html">ADD VESSEL</a></li>
                </ul>
            </li>
        </ul>
    </section>

    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content-dashboard" class="content">
        <!-- MAIN -->
        <main>
            <div class="head-title">
                <h1>Dashboard</h1>
                <ul class="breadcrumb">
                    <li><a href="#">Dashboard</a></li>
                    <li><i class='bx bx-chevron-right'></i></li>
                </ul>
                <a href="#" class="btn btn-primary btn-download">
                    <i class='bx bxs-cloud-download'></i>
                    Download PDF
                </a>
            </div>

            <!-- Stats Section -->
            <div class="stats-container row">
                <div class="col-md-2 stat-card text-center">
                    <h3>Toplam Tüketim</h3>
                    <p id="total-consumption-value">Yükleniyor...</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>Complian Balance</h3>
                    <p id="complian-balance-value">Yükleniyor...</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>GHG Intensity</h3>
                    <p id="ghg_intensity-value">Yükleniyor...</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>FuelEU Cost</h3>
                    <p>12,152</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>ETS Cost</h3>
                    <p>94,127</p>
                </div>
                <div class="col-md-2 stat-card text-center">
                    <h3>Total Cost</h3>
                    <p>168,540</p>
                </div>
            </div>

            <!-- Vessel Data Table -->
            <div class="vessel-table-container mt-4">
                <h2>All Vessels</h2>
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Vessel Name</th>
                            <th>Sea Fuel</th>
                            <th>Sea Consumption</th>
                            <th>ECA Fuel</th>
                            <th>ECA Consumption</th>
                            <th>Port Fuel</th>
                            <th>Port Consumption</th>
                            <th>CII Rating</th>
                        </tr>
                    </thead>
                    <tbody id="vessel-table-body">
                        <!-- Dinamik veri buraya yüklenecek -->
                    </tbody>
                </table>
            </div>

            <!-- Line Chart (Chart.js) -->
            <section id="content-dashboard" class="content">
                <main>
                    <div class="head-title">
                        <h1>ETS Dashboard</h1>
                    </div>
        
                    <!-- Date Filters -->
                    <div class="filter-container">
                        <label for="start-date-1">Start Date (Chart 1):</label>
                        <input type="date" id="start-date-1">
                        <label for="end-date-1">End Date (Chart 1):</label>
                        <input type="date" id="end-date-1">
                        <button id="update-chart-1" class="btn">Update Chart 1</button>
                    </div>
                    
                    <!-- Date Filters for Chart 2 -->
                    <div class="filter-container">
                        <label for="start-date-2">Start Date (Chart 2):</label>
                        <input type="date" id="start-date-2">
                        <label for="end-date-2">End Date (Chart 2):</label>
                        <input type="date" id="end-date-2">
                        <button id="update-chart-2" class="btn">Update Chart 2</button>
                    </div>
                    
                    <!-- Chart Containers -->
                    <div class="chart-row">
                        <div class="chart-box chart-container">
                            <canvas id="myLineChart1"></canvas>
                        </div>
                        <div class="chart-box chart-container">
                            <canvas id="myLineChart2"></canvas>
                        </div>
                    </div>
                </main>
            </section>
        
    <script>
       
       let chart1Instance, chart2Instance;

// Ay bazlı ETS grafiği (1. Grafik)
function createLineChart1(labels, data, label) {
    const ctx = document.getElementById('myLineChart1').getContext('2d');
    if (chart1Instance) {
        chart1Instance.destroy(); // Eski grafiği yok et
    }

    chart1Instance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Gemi isimlerine göre ETS grafiği (2. Grafik)
function createLineChart2(dataSets, months) {
    const ctx = document.getElementById('myLineChart2').getContext('2d');
    if (chart2Instance) {
        chart2Instance.destroy(); // Eski grafiği yok et
    }

    chart2Instance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months, // X ekseninde aylar
            datasets: dataSets // Gemiler için dinamik çizgi seti
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// 1. Grafik için tarih aralığına göre verileri güncelle
document.getElementById('update-chart-1').addEventListener('click', function() {
    const startDate1 = document.getElementById('start-date-1').value;
    const endDate1 = document.getElementById('end-date-1').value;

    if (!startDate1 || !endDate1) {
        alert('Please select both start and end dates for the first chart.');
        return;
    }

    // İlk grafik (Ay bazlı ETS toplamı)
    fetch(`/api/get-data?start=${startDate1}&end=${endDate1}`)
        .then(response => response.json())
        .then(data => {
            console.log("Ay bazlı ETS verileri (1. Grafik):", data); // Konsolda verileri görüntüle
            const labels = data.map(item => item.month_name);
            const values = data.map(item => item.total_ets);
            createLineChart1(labels, values, 'Monthly ETS');
        })
        .catch(error => console.error('Error fetching data for the first chart:', error));
});

// 2. Grafik için tarih aralığına göre verileri güncelle
document.getElementById('update-chart-2').addEventListener('click', function() {
    const startDate2 = document.getElementById('start-date-2').value;
    const endDate2 = document.getElementById('end-date-2').value;

    if (!startDate2 || !endDate2) {
        alert('Please select both start and end dates for the second chart.');
        return;
    }

    // İkinci grafik (Vessel name bazlı ETS, Aylar X ekseninde)
    fetch(`/api/get-vessel-data?start=${startDate2}&end=${endDate2}`)
        .then(response => response.json())
        .then(data => {
            console.log("Gemi bazlı ETS verileri (2. Grafik):", data); // Konsolda verileri görüntüle
            
            // Aylara göre benzersiz ay isimlerini alıyoruz
            const months = [...new Set(data.map(item => item.month_name))];

            // Her gemi için ayrı bir dataset hazırlıyoruz
            const vesselNames = [...new Set(data.map(item => item.vessel_name))];
            const datasets = vesselNames.map((vessel) => {
                const vesselData = data.filter(item => item.vessel_name === vessel);
                const etsValues = vesselData.map(item => item.total_ets);

                // Dinamik renkler üretmek için random bir renk seçelim
                const randomColor = `rgb(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)})`;

                return {
                    label: vessel,
                    data: etsValues,
                    fill: false,
                    borderColor: randomColor,
                    tension: 0.1
                };
            });

            createLineChart2(datasets, months);
        })
        .catch(error => console.error('Error fetching vessel data for the second chart:', error));
});

// Varsayılan grafik verisi (İlk yükleme için)
window.onload = function () {
    const defaultLabels = ['January', 'February', 'March', 'April', 'May', 'June', 'July'];
    const defaultData = [0, 0, 0, 0, 0, 0, 0];
    createLineChart1(defaultLabels, defaultData, 'Monthly ETS');
    createLineChart2([], defaultLabels);



            // Diğer fonksiyonlar aynı window.onload içine dahil edilebilir
            fetchTotalConsumption();
            fetchComplianBalance();
            fetchghgintensity();
            fetchVesselData();
        };

        // API'den verileri çek ve tabloyu güncelle
        async function fetchTotalConsumption() {
            try {
                const response = await fetch('/api/total-consumption');
                const data = await response.json();
                document.getElementById('total-consumption-value').textContent = data.totalConsumption;
            } catch (error) {
                console.error('Toplam tüketim verisi çekilirken bir hata oluştu:', error);
            }
        }

        async function fetchComplianBalance() {
            try {
                const response = await fetch('/api/complian-balance');
                const data = await response.json();
                document.getElementById('complian-balance-value').textContent = data.complianBalance;
            } catch (error) {
                console.error('Complian balance verisi çekilirken bir hata oluştu:', error);
            }
        }

        async function fetchghgintensity() {
            try {
                const response = await fetch('/api/ghg_intensity');
                const data = await response.json();
                document.getElementById('ghg_intensity-value').textContent = data.GHG_intensity;
            } catch (error) {
                console.error('GHG intensity verisi çekilirken bir hata oluştu:', error);
            }
        }

        async function fetchVesselData() {
            try {
                const response = await fetch('/api/vessels');  // API'ye istek gönder
                const vessels = await response.json();  // Gelen JSON verisini al

                const tableBody = document.getElementById('vessel-table-body');

                vessels.forEach(vessel => {
                    const row = document.createElement('tr');
                    const ciiRating = vessel.CII ? vessel.CII.toLowerCase() : 'n/a';
                    row.innerHTML = `
                        <td>${vessel.vessel_name}</td>
                        <td>${vessel.sea_fuel}</td>
                        <td>${vessel.sea_consumption}</td>
                        <td>${vessel.eca_fuel}</td>
                        <td>${vessel.eca_consumption}</td>
                        <td>${vessel.port_fuel}</td>
                        <td>${vessel.port_consumption}</td>
                        <td><span class="cii-rating ${ciiRating}">${vessel.CII || 'N/A'}</span></td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Veriler çekilirken bir hata oluştu:', error);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./static/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
