<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/dashboard.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>Erkport</title>
</head>

<body>

    <div class="container-fluid py-2">
        <div class="row d-flex">

            <div class="container col-sm-12 col-md-3 col-xl-2 mb-sm-5 nav-div">

                <nav>
                    <div class="container-fluid">
                        <div class="navbar-brand col-12">
                            <img src="/static/image/erk.png" class="w-100" alt="arkas logo">
                        </div>

                        <hr>

                        <div class="container-fluid">
                            <ul class="menu-links my-2 p-2 col-12">
                                <li class="nav-item">
                                    <a class="nav-link" href="./">DASHBOARD</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./ets.html">ETS</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./cii.html">CII</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./fuel_eu.html">FUEL EU</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./input.html">INPUT</a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="./pool.html">POOL</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="./pooldetails.html">POOL DETAILS</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="logout-button-div">
                        <button class="btn btn-danger logout-button fw-bold col-12">Logout</button>
                    </div>

                </nav>
            </div>

            <div class="container-fluid col-sm-12 col-md-9 col-xl-10 mt-sm-2 mt-md-2 pt-3 px-4">

                <div class="container header-and-button">
                    <div class="header">
                        <h2 class="h2 fw-bold mx-sm-3 mx-xl-4 my-3">ETS Data Table</h2>
                    </div>
                    <div class="downland-pdf-button-div">
                        <button id="exportExcel" class="btn btn-outline-success">Export to Excel</button>
                    </div>
                    
                </div>




                <button id="showSelectedVessel" class="btn btn-warning mt-4 mb-3">Show Selected Vessel</button>

                <!-- Modal Structure -->
                <div id="vesselModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>

                        <!-- Step 1: Vessel Selection -->
                        <div id="step1">
                            <h2>Select Vessels</h2>
                            <div id="vesselCheckboxes"></div>
                            <label><input type="checkbox" id="selectAllVessels"> Select All Vessels</label><br><br>
                            <button id="nextStep" class="btn btn-dark">Next</button>
                        </div>

                        <!-- Step 2: Column Selection -->
                        <div id="step2" style="display:none;">
                            <h2>Select Columns</h2>
                            <div id="columnCheckboxes">
                                <label><input type="checkbox" value="distance" checked> Total Distance</label><br>
                                <label><input type="checkbox" value="eca_distance" checked> Total ECA
                                    Distance</label><br>
                                <label><input type="checkbox" value="speed" checked> Average Speed</label><br>
                                <label><input type="checkbox" value="total_days" checked> Total Days</label><br>
                                <label><input type="checkbox" value="sea_fuel" checked> Sea Fuel</label><br>
                                <label><input type="checkbox" value="sea_consumption" checked> Sea
                                    Consumption</label><br>
                                <label><input type="checkbox" value="eca_fuel" checked> ECA Fuel</label><br>
                                <label><input type="checkbox" value="eca_consumption" checked> ECA
                                    Consumption</label><br>
                                <label><input type="checkbox" value="port_fuel" checked> Port Fuel</label><br>
                                <label><input type="checkbox" value="port_consumption" checked> Port
                                    Consumption</label><br>
                                <label><input type="checkbox" value="ets" checked> ETS</label><br>
                            </div>
                            <button id="showData" class="btn btn-primary">Show Data</button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="vesselTable" class="table table-responsive" style="max-height: 440px; overflow-y: auto;">
                        <thead class="table-warning">
                            <tr>
                                <th class="vessel-name">Vessel Name</th>
                                <th class="distance">Total Distance</th>
                                <th class="eca_distance">Total ECA Distance</th>
                                <th class="speed">Average Speed</th>
                                <th class="total_days">Total Days</th>
                                <th class="sea_fuel">Sea Fuel</th>
                                <th class="sea_consumption">Sea Consumption</th>
                                <th class="eca_fuel">ECA Fuel</th>
                                <th class="eca_consumption">ECA Consumption</th>
                                <th class="port_fuel">Port Fuel</th>
                                <th class="port_consumption">Port Consumption</th>
                                <th class="ets">ETS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dinamik veri buraya fetch ile yüklenecek -->
                        </tbody>
                    </table>
                </div>

                <button id="backToMainTable" class="btn btn-warning" style="display:none;">Back to Main Table</button>
                </main>
                </section>

                <script>
                    let originalData = []; // Verilerin saklanacağı dizi

// Gemi verilerini çekme işlemi
fetch('/api/get-vessel-data')
    .then(response => response.json())
    .then(data => {
        originalData = data; // Verileri sakla
        populateTable(data); // Tabloyu doldur
        populateModalWithVessels(data); // Modal için gemileri doldur
    })
    .catch(error => console.error('Gemi verileri alınırken hata oluştu:', error));

// Modal açma ve kapama işlemleri
const modal = document.getElementById("vesselModal");
const showSelectedVesselBtn = document.getElementById("showSelectedVessel");
const closeModalBtn = document.querySelector(".close");

showSelectedVesselBtn.onclick = () => {
    modal.style.display = "block";
    document.getElementById('step1').style.display = 'block'; // Adım 1'i göster
    document.getElementById('step2').style.display = 'none'; // Adım 2'yi gizle
};

closeModalBtn.onclick = () => modal.style.display = "none";
window.onclick = (event) => {
    if (event.target === modal) {
        modal.style.display = "none";
    }
};

// 'Next' butonuna tıklanınca adımları değiştir
document.getElementById('nextStep').addEventListener('click', () => {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
});

// Filtreleri uygulama işlemi
document.getElementById('showData').addEventListener('click', () => {
    // Seçilen gemileri al
    const selectedVessels = Array.from(document.querySelectorAll('#vesselCheckboxes input:checked')).map(checkbox => checkbox.value);

    // Seçilen sütunları al
    const selectedColumns = Array.from(document.querySelectorAll('#columnCheckboxes input:checked')).map(checkbox => checkbox.value);

    // Seçilen gemilere göre veriyi filtrele
    const filteredData = selectedVessels.length > 0 ? originalData.filter(row => selectedVessels.includes(row.vessel_name)) : originalData;

    // Filtrelenmiş tabloyu doldur
    populateTable(filteredData);

    // Yalnızca seçilen sütunları göster
    document.querySelectorAll('#vesselTable th, #vesselTable td').forEach(cell => {
        const columnClass = cell.className;
        if (selectedColumns.includes(columnClass) || columnClass === 'vessel-name') {
            cell.style.display = ''; // Seçilen sütunları göster
        } else {
            cell.style.display = 'none'; // Seçilmeyen sütunları gizle
        }
    });

    // Modalı kapat
    modal.style.display = 'none';

    // Geri butonunu göster
    document.getElementById('backToMainTable').style.display = 'inline-block';
});

// Geri butonu işlevi (orijinal tabloyu geri yükleme)
document.getElementById('backToMainTable').addEventListener('click', () => {
    // Orijinal verilerle tabloyu doldur
    populateTable(originalData);

    // Tüm sütunları göster
    document.querySelectorAll('#vesselTable th, #vesselTable td').forEach(cell => {
        cell.style.display = ''; // Tüm sütunları göster
    });

    // Geri butonunu gizle
    document.getElementById('backToMainTable').style.display = 'none';
});

// Modalda gemi isimlerini dinamik olarak ekleme işlevi
function populateModalWithVessels(data) {
    const vesselCheckboxes = document.getElementById('vesselCheckboxes');
    vesselCheckboxes.innerHTML = '';

    const uniqueVesselNames = [...new Set(data.map(row => row.vessel_name))];

    uniqueVesselNames.forEach(name => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${name}"> ${name}<br>`;
        vesselCheckboxes.appendChild(label);
    });

    // Select All işlevi
    document.getElementById('selectAllVessels').addEventListener('change', function () {
        const vesselCheckboxes = document.querySelectorAll('#vesselCheckboxes input[type="checkbox"]');
        vesselCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
}

// Tabloyu dinamik verilerle doldurmak için işlev
function populateTable(data) {
    const tableBody = document.querySelector("#vesselTable tbody");
    tableBody.innerHTML = '';

    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12">Veri yok</td></tr>';
        return;
    }

    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="vessel-name">${row.vessel_name}</td>
            <td class="distance">${row.distance_sum || 'N/A'}</td>
            <td class="eca_distance">${row.distance_eca_sum || 'N/A'}</td>
            <td class="speed">${row.speed_avg || 'N/A'}</td>
            <td class="total_days">${row.total_days || 'N/A'}</td>
            <td class="sea_fuel">${row.sea_fuel || 'N/A'}</td>
            <td class="sea_consumption">${row.sea_consumption || 'N/A'}</td>
            <td class="eca_fuel">${row.eca_fuel || 'N/A'}</td>
            <td class="eca_consumption">${row.eca_consumption || 'N/A'}</td>
            <td class="port_fuel">${row.port_fuel || 'N/A'}</td>
            <td class="port_consumption">${row.port_consumption || 'N/A'}</td>
            <td class="ets">${row.ets_sum || 'N/A'}</td>
        `;
        tableBody.appendChild(tr);
    });
}

// Sadece bir kez tabloya tıklama olayını ekleyin (çift tıklama olaylarını önlemek için)
document.querySelector("#vesselTable tbody").addEventListener('click', function (event) {
    const target = event.target;

    if (target.classList.contains('vessel-name')) {
        const vesselName = target.innerText;
        const parentRow = target.parentNode;

        // Eğer bir detay satırı zaten varsa onu kaldır (kapat)
        if (parentRow.nextElementSibling && parentRow.nextElementSibling.classList.contains('details-row')) {
            parentRow.nextElementSibling.remove(); // Detay satırını kapat
        } else {
            // Mevcut tüm detay satırlarını kaldır (her tıklamada temizlenir)
            document.querySelectorAll('.details-row').forEach(row => row.remove());

            // Detay verilerini API'den çek ve göster
            fetch(`/api/get-vessel-detail?vessel_name=${vesselName}`)
                .then(response => response.json())
                .then(detailData => {
                    const detailRow = document.createElement('tr');
                    detailRow.classList.add('details-row');

                    detailRow.innerHTML = `
                        <td colspan="12">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>From - To</th>
                                        <th>Total Distance</th>
                                        <th>Total ECA Distance</th>
                                        <th>Average Speed</th>
                                        <th>Total Days</th>
                                        <th>Sea Fuel</th>
                                        <th>Sea Consumption</th>
                                        <th>ECA Fuel</th>
                                        <th>ECA Consumption</th>
                                        <th>Port Fuel</th>
                                        <th>Port Consumption</th>
                                        <th>ETS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${detailData.map(det => `
                                        <tr>
                                            <td>${det.from_liman} - ${det.to_liman}</td>
                                            <td>${det.distance_sum || 'N/A'}</td>
                                            <td>${det.distance_eca_sum || 'N/A'}</td>
                                            <td>${det.speed_avg || 'N/A'}</td>
                                            <td>${det.total_days || 'N/A'}</td>
                                            <td>${det.sea_fuel || 'N/A'}</td>
                                            <td>${det.sea_consumption || 'N/A'}</td>
                                            <td>${det.eca_fuel || 'N/A'}</td>
                                            <td>${det.eca_consumption || 'N/A'}</td>
                                            <td>${det.port_fuel || 'N/A'}</td>
                                            <td>${det.port_consumption || 'N/A'}</td>
                                            <td>${det.ets_sum || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </td>
                    `;
                    parentRow.insertAdjacentElement('afterend', detailRow); // Detay satırını ekle
                })
                .catch(error => console.error('Detay verileri alınırken hata oluştu:', error));
        }
    }
});

// Excel dosyasını indirme işlemi
document.getElementById('exportExcel').addEventListener('click', () => {
    const selectedRows = [];
    const tableHeaders = [];

    // Tablodaki sütun başlıklarını al
    document.querySelectorAll('#vesselTable thead th').forEach((header, index) => {
        tableHeaders.push(header.innerText); // Sütun başlıklarını diziye ekliyoruz
    });

    // Tablodaki verileri al (sadece görünür olanları)
    document.querySelectorAll('#vesselTable tbody tr').forEach(row => {
        const rowData = {};
        row.querySelectorAll('td').forEach((cell, index) => {
            rowData[tableHeaders[index]] = cell.innerText; // Her hücreyi ilgili sütun başlığıyla eşleştiriyoruz
        });
        selectedRows.push(rowData); // Satırı listeye ekliyoruz
    });

    // Verileri sunucuya gönder
    fetch('/export-excel2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ selectedRows }) // Seçilen satırları JSON formatında gönderiyoruz
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Excel dosyası indirme hatası');
        }
        return response.blob(); // Excel dosyasını blob olarak alıyoruz
    })
    .then(blob => {
        // Excel dosyasını indirmek için URL oluşturuyoruz
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'selected_vessels.xlsx';
        document.body.appendChild(a);
        a.click();
        a.remove();
    })
    .catch(error => {
        console.error('Excel export hatası:', error);
    });
});



                </script>





                <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
                    crossorigin="anonymous"></script>
                <script src="charts.js"></script>

</body>

</html>