<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vessel Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style2.css">
</head>

<body>
    <!-- SIDEBAR -->
    <section id="sidebar">
        <a href="#" class="brand">
            <span class="text">Dashboard</span>
        </a>
        <ul class="side-menu top">
            <li class="active">
                <a href="./">
                    <span class="text">DASHBOARD</span>
                </a>
            </li>
            <li>
                <a href="./ets.html">
                    <span class="text">ETS</span>
                </a>
            </li>
            <li>
                <a href="./cii.html">
                    <span class="text">CII</span>
                </a>
            </li>
            <li>
                <a href="./fuel_eu.html">
                    <span class="text">FUEL EU</span>
                </a>
            </li>
            <li>
                <a href="./input.html">
                    <span class="text">INPUT</span>
                </a>
            </li>
            <li>
                <a href="./pool.html">
                    <span class="text">pool</span>
                </a>
            </li>
        </ul>
    </section>
    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content-dashboard">
        <!-- NAVBAR -->
        <nav>
            <a href="#" class="nav-link">Search</a>
            <form action="#">
                <div class="form-input">
                    <input type="search" placeholder="Search...">
                    <button type="submit" class="search-btn">Search</button>
                </div>
            </form>
        </nav>
        <!-- NAVBAR -->

        <!-- MAIN -->
        <main>
            <div class="head-title">
                <div class="left">
                    <h1>Dashboard</h1>
                    <ul class="breadcrumb">
                        <li><a href="#">Dashboard</a></li>
                        <li>Vessel Consumption and ETS Report</li>
                    </ul>
                </div>
                <a href="#" id="btn-download-pdf" class="btn-download">
                    <span class="text">Download PDF</span>
                </a>
            </div>

            <!-- Modal to select vessels -->
            <div class="modal fade" id="vesselModal" tabindex="-1" aria-labelledby="vesselModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered"> <!-- modal-dialog-centered ile modal ekranın ortasında olur -->
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="vesselModalLabel">Select Vessels</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="vessel-checkboxes">
                                <!-- Vessel checkbox content will be dynamically populated -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="save-vessel-selection">Save Selection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form to select vessel and date range -->
            <div class="container mt-4">
                <form id="vessel-form">
                    <div class="form-input-inline">
                        <div class="mb-3">
                            <label for="vessel" class="form-label">Select Vessel(s)</label>
                            <input type="text" id="selected-vessels" class="form-control" readonly data-bs-toggle="modal" data-bs-target="#vesselModal" placeholder="Click to select vessels">
                        </div>

                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Get Report</button>
                </form>
            </div>

            <!-- Table to display report data -->
            <div class="table-responsive mt-4">
                <table id="vesselTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Vessel Name</th>
                            <th>Sefer Tekrar Sayısı</th>
                            <th>Leg Durumu</th>
                            <th>Current Leg</th>
                            <th>Total Distance</th>
                            <th>ECA Distance</th>
                            <th>Sea Fuel Consumption</th>
                            <th>ECA Fuel Consumption</th>
                            <th>Port Fuel Consumption</th>
                            <th>ETS</th>
                            <th>Compliance Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pool button -->
            <button id="pool-button" class="btn btn-primary mt-4">Pool</button>

            <!-- Modal to show result -->
            <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="resultModalLabel">Pooling Result</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="modal-body-content">
                            <!-- Results will be dynamically inserted here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load vessel names into the modal
        async function loadVesselNames() {
            try {
                const response = await fetch('/api/vessels');
                const vesselNames = await response.json();
    
                const vesselCheckboxes = document.getElementById('vessel-checkboxes');
                vesselCheckboxes.innerHTML = '';  // Clear previous content
    
                vesselNames.forEach(vessel => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.classList.add('checkbox-inline');
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="vessel-${vessel.vessel_name}" value="${vessel.vessel_name}">
                        <label for="vessel-${vessel.vessel_name}">${vessel.vessel_name}</label>
                    `;
                    vesselCheckboxes.appendChild(checkboxDiv);
                });
            } catch (error) {
                console.error('Error loading vessels:', error);
            }
        }
    
        // Save vessel selection from modal
        document.getElementById('save-vessel-selection').addEventListener('click', function() {
            const selectedVessels = Array.from(document.querySelectorAll('#vessel-checkboxes input[type="checkbox"]:checked'))
                .map(cb => cb.value)
                .join(', ');
    
            document.getElementById('selected-vessels').value = selectedVessels || 'No vessel selected';
        });
    
        // Form submission to get report
        document.getElementById('vessel-form').addEventListener('submit', async function(event) {
            event.preventDefault();
    
            const vessels = document.getElementById('selected-vessels').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
    
            if (!vessels || vessels === 'No vessel selected') {
                alert('Please select at least one vessel.');
                return;
            }
    
            try {
                const response = await fetch(`/api/vessel-report?startDate=${startDate}&endDate=${endDate}&vessels=${vessels}`);
                const results = await response.json();
    
                const tableBody = document.querySelector('#vesselTable tbody');
                tableBody.innerHTML = '';  // Clear previous table data
    
                results.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox" class="vessel-checkbox" value="${row.vessel_name}"></td>
                        <td>${row.vessel_name}</td>
                        <td>${row.sefer_tekrar_sayisi}</td>
                        <td>${row.leg_durumu}</td>
                        <td>${row.current_leg}</td>
                        <td>${row.distance_sum}</td>
                        <td>${row.distance_eca_sum}</td>
                        <td>${row.sea_fuel_sum}</td>
                        <td>${row.eca_fuel_sum}</td>
                        <td>${row.port_fuel_sum}</td>
                        <td>${row.ets_sum}</td>
                        <td>${row.complian_balance}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error fetching report:', error);
            }
        });
    
        // Pool button logic with modal table display and coloring
        
    document.getElementById('pool-button').addEventListener('click', function () {
        const selectedRows = Array.from(document.querySelectorAll('#vesselTable tbody tr'))
            .filter(row => row.querySelector('input[type="checkbox"]').checked);

        let positiveBalance = 0;
        let negativeBalances = [];

        selectedRows.forEach(row => {
            const complianceBalance = parseFloat(row.cells[11].textContent);
            if (complianceBalance > 0) {
                positiveBalance += complianceBalance;
            } else if (complianceBalance < 0) {
                negativeBalances.push({ row, complianceBalance });
            }
        });

        let modalTableContent = `
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Vessel Name</th>
                        <th>Sefer Tekrar Sayısı</th>
                        <th>Leg Durumu</th>
                        <th>Current Leg</th>
                        <th>Total Distance</th>
                        <th>ECA Distance</th>
                        <th>Sea Fuel Consumption</th>
                        <th>ECA Fuel Consumption</th>
                        <th>Port Fuel Consumption</th>
                        <th>ETS</th>
                        <th>Compliance Balance</th>
                    </tr>
                </thead>
                <tbody>
        `;

        negativeBalances.forEach(({ row, complianceBalance }) => {
            let textClass = '';

            if (positiveBalance + complianceBalance >= 0) {
                positiveBalance += complianceBalance;
                textClass = 'text-zero';
                modalTableContent += `<tr>`;
                modalTableContent += row.innerHTML.replace(`<td>${complianceBalance}</td>`, `<td class="${textClass}">0</td>`);
            } else {
                textClass = 'text-negative';
                modalTableContent += `<tr>`;
                modalTableContent += row.innerHTML.replace(`<td>${complianceBalance}</td>`, `<td class="${textClass}">${(complianceBalance + positiveBalance).toFixed(2)}</td>`);
                positiveBalance = 0;
            }
            modalTableContent += `</tr>`;
        });

        selectedRows.forEach(row => {
            const complianceBalance = parseFloat(row.cells[11].textContent);
            if (complianceBalance > 0) {
                modalTableContent += `<tr><td>${row.cells[0].innerHTML}</td><td>${row.cells[1].innerHTML}</td><td>${row.cells[2].innerHTML}</td><td>${row.cells[3].innerHTML}</td><td>${row.cells[4].innerHTML}</td><td>${row.cells[5].innerHTML}</td><td>${row.cells[6].innerHTML}</td><td>${row.cells[7].innerHTML}</td><td>${row.cells[8].innerHTML}</td><td>${row.cells[9].innerHTML}</td><td>${row.cells[10].innerHTML}</td><td class="text-positive">${row.cells[11].innerHTML}</td></tr>`;
            }
        });

        let resultMessage = positiveBalance !== 0
            ? `Remaining Compliance Balance: ${positiveBalance.toFixed(2)}`
            : "All balances are settled.";

        modalTableContent += `
                </tbody>
            </table>
            <p>${resultMessage}</p>
            <div class="mb-3">
                <label for="poolName" class="form-label">Pool Name</label>
                <input type="text" id="poolName" class="form-control" placeholder="Enter pool name">
            </div>
            <button id="save-pool" class="btn btn-primary">Save Pool</button>
        `;

        document.getElementById('modal-body-content').innerHTML = modalTableContent;

        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        resultModal.show();

        // Save Pool Button Click Event
        document.getElementById('save-pool').addEventListener('click', async function () {
            const poolName = document.getElementById('poolName').value;

            if (!poolName) {
                alert('Please enter a pool name.');
                return;
            }

            const tableData = selectedRows.map(row => {
                return {
                    vessel_name: row.cells[1].textContent,
                    sefer_tekrar_sayisi: row.cells[2].textContent,
                    leg_durumu: row.cells[3].textContent,
                    current_leg: row.cells[4].textContent,
                    total_distance: row.cells[5].textContent,
                    eca_distance: row.cells[6].textContent,
                    sea_fuel_consumption: row.cells[7].textContent,
                    eca_fuel_consumption: row.cells[8].textContent,
                    port_fuel_consumption: row.cells[9].textContent,
                    ets: row.cells[10].textContent,
                    compliance_balance: row.cells[11].textContent
                };
            });

            try {
                const response = await fetch('/save-pool', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ poolName, tableData })
                });

                if (response.ok) {
                    alert('Pool saved successfully!');
                    resultModal.hide();
                } else {
                    alert('Failed to save pool.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving the pool.');
            }
        });
    });
</script>

    
</body>
</html>
