<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemi Yakıt Verileri</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/static/css/style2.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    /* Ekstra stil eklemeleri */
    /* Ekstra stil eklemeleri */
    .form-group {
      margin-bottom: 15px;
    }
    .form-control {
      padding: 5px;
      font-size: 0.9rem;
    }
    .form-label {
      font-weight: bold;
      font-size: 0.85rem;
    }
    .btn {
      padding: 8px 20px;
    }
    .ayakInput {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #95e3f4;
      border-radius: 5px;
      background-color: #10c9ea; /* Tüm ayakInput'lar için açık mavi arka plan */
    }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <section id="sidebar">
    <a href="#" class="brand">
        <i class='bx bxs-smile'></i>
        <span class="text">Dashboard</span>
    </a>
    <ul class="side-menu top">
        <li class="active">
            <a href="./">
                <i class='bx bxs-dashboard'></i>
                <span class="text">DASHBOARD</span>
            </a>
        </li>
        <li>
            <a href="./ets.html">
                <i class='bx bxs-shopping-bag-alt'></i>
                <span class="text">ETS</span>
            </a>
        </li>
        <li>
            <a href="./cii.html">
                <i class='bx bxs-shopping-bag-alt'></i>
                <span class="text">CII</span>
            </a>
        </li>
        <li>
            <a href="./fuel_eu.html">
                <i class='bx bxs-doughnut-chart'></i>
                <span class="text">FUEL EU</span>
            </a>
        </li>
        <li>
            <a href="./input.html">
                <i class='bx bxs-message-dots'></i>
                <span class="text">INPUT</span>
            </a>
        </li>
    </ul>
    <ul class="side-menu">
        <li>
            <a href="#" class="logout">
                <i class='bx bxs-log-out-circle'></i>
                <span class="text">Logout</span>
            </a>
        </li>
    </ul>
</section>
<!-- SIDEBAR -->

<!-- CONTENT -->
<section id="content-dashboard">
    <!-- NAVBAR -->
    <nav>
        <i class='bx bx-menu'></i>
        <a href="#" class="nav-link">Search</a>
        <form action="#">
            <div class="form-input">
                <input type="search" placeholder="Search...">
                <button type="submit" class="search-btn"><i class='bx bx-search'></i></button>
            </div>
        </form>
        <input type="checkbox" id="switch-mode" hidden>
        <label for="switch-mode" class="switch-mode"></label>
        <a href="#" class="notification">
            <i class='bx bxs-bell'></i>
        </a>
    </nav>
    <!-- NAVBAR -->

    <!-- MAIN -->
    <main>
        <div class="head-title">
            <div class="left">
                <h1>Dashboard</h1>
                <ul class="breadcrumb">
                    <li>
                        <a href="#">Dashboard</a>
                    </li>
                    <li><i class='bx bx-chevron-right'></i></li>
                </ul>
            </div>
            <a href="#" id="btn-download-pdf" class="btn btn-primary">
                <i class='bx bxs-cloud-download'></i>
                <span class="text">Download PDF</span>
            </a>
        </div>

        <h2>Log Voyage</h2>
        <form id="seferForm" class="container">
          <div class="form-group row">
            <label for="vessel_name" class="col-sm-2 col-form-label form-label">Vessel Name:</label>
            <div class="col-sm-4">
              <input type="text" id="vessel_name" name="vessel_name" class="form-control" required>
            </div>
          </div>
  
          <div class="form-group row">
            <label for="start_date" class="col-sm-2 col-form-label form-label">Start Date:</label>
            <div class="col-sm-4">
              <input type="date" id="start_date" name="start_date" class="form-control" required>
            </div>
          </div>
  
          <div id="ayakInputs">
            <!-- İlk ayak için form inputları -->
            <div class="ayakInput row" id="ayak_1">
              <div class="col-sm-6">
                <label for="from_1" class="form-label">From:</label>
                <select id="from_1" name="from_1" class="form-control" required></select>
              </div>
              <div class="col-sm-6">
                <label for="to_1" class="form-label">To:</label>
                <select id="to_1" name="to_1" class="form-control" required></select>
              </div>
              <div class="col-sm-6">
                <label for="distance_1" class="form-label">Distance (nm):</label>
                <input type="number" id="distance_1" name="distance_1" class="form-control" step="any" required>
              </div>
              <div class="col-sm-6">
                <label for="distance_eca_1" class="form-label">Distance ECA (nm):</label>
                <input type="number" id="distance_eca_1" name="distance_eca_1" class="form-control" step="any" required>
              </div>
              <div class="col-sm-6">
                <label for="port_day_1" class="form-label">Port Day :</label>
                <input type="number" id="port_day_1" name="port_day_1" class="form-control" step="any" required>
              </div>
              <div class="col-sm-6">
                <label for="port_fuel_1" class="form-label">Port Fuel (mt/24):</label>
                <select id="port_fuel_1" name="port_fuel_1" class="form-control" required></select>
              </div>
              <div class="col-sm-6">
                <label for="sea_fuel_1" class="form-label">Sea Fuel (mt/24):</label>
                <select id="sea_fuel_1" name="sea_fuel_1" class="form-control" required></select>
              </div>
              <div class="col-sm-6">
                <label for="eca_fuel_1" class="form-label">ECA Sea Fuel:</label>
                <select id="eca_fuel_1" name="eca_fuel_1" class="form-control" required></select>
              </div>
            </div>
          </div>
  
          <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="addAyak()">Add</button>
          </div>
  
          <div class="form-group row">
            <label for="speed" class="col-sm-2 col-form-label form-label">Speed (kts):</label>
            <div class="col-sm-4">
              <input type="number" id="speed" name="speed" class="form-control" step="any" required>
            </div>
          </div>
  
          <div class="form-group row">
            <label for="gunluk_tuketim_sea" class="col-sm-2 col-form-label form-label">Daily Consumption Sea (mt):</label>
            <div class="col-sm-4">
              <input type="number" id="gunluk_tuketim_sea" name="gunluk_tuketim_sea" class="form-control" step="any" required>
            </div>
          </div>
  
          <div class="form-group row">
            <label for="gunluk_tuketim_port" class="col-sm-2 col-form-label form-label">Daily Consumption (mt):</label>
            <div class="col-sm-4">
              <input type="number" id="gunluk_tuketim_port" name="gunluk_tuketim_port" class="form-control" step="any" required>
            </div>
          </div>
  
          <div class="form-group row">
            <label for="DWT" class="col-sm-2 col-form-label form-label">DWT:</label>
            <div class="col-sm-4">
              <input type="number" id="DWT" name="DWT" class="form-control" step="any" required>
            </div>
          </div>

        <button type="submit" class="btn btn-primary">Seferi Kaydet</button>
      </form>
      <h2>CSV/Excel Dosyası Yükleyin</h2>
      <form id="seferFormcsv" enctype="multipart/form-data">
        <div>
          <label for="file_input">CSV/Excel Yükle:</label>
          <input type="file" id="file_input" name="file_input" accept=".csv, .xls, .xlsx" required>
        </div>
        <button type="submit">Dosyayı Yükle</button>
      </form>
      
      <script>
        document.getElementById("seferFormcsv").addEventListener("submit", function(event) {
          event.preventDefault();
          
          const formData = new FormData(document.getElementById("seferFormcsv"));
          
          fetch('/excel/csv', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            alert(`Başarılı Kayıtlar: ${data.succesData.length}, Başarısız Kayıtlar: ${data.FailureData.length}`);
          })
          .catch(error => {
            console.error("Hata oluştu:", error);
            alert("Kayıt işlemi sırasında hata oluştu.");
          });
        });

  let ayakCount = 1;
  let rotaData = [];
  let fuelData = [];

  function addAyak() {
    ayakCount++;
    const ayakInputs = document.getElementById("ayakInputs");

    const previousTo = document.getElementById(`to_${ayakCount - 1}`).value;

    const newAyak = document.createElement("div");
    newAyak.classList.add("ayakInput", "row");
    newAyak.innerHTML = `
      <div class="col-sm-6">
        <label for="from_${ayakCount}" class="form-label">From Ayak ${ayakCount}:</label>
        <select id="from_${ayakCount}" name="from_${ayakCount}" class="form-control" required>${generateOptions(rotaData)}</select>
      </div>
      <div class="col-sm-6">
        <label for="to_${ayakCount}" class="form-label">To Ayak ${ayakCount}:</label>
        <select id="to_${ayakCount}" name="to_${ayakCount}" class="form-control" required>${generateOptions(rotaData)}</select>
      </div>
      <div class="col-sm-6">
        <label for="distance_${ayakCount}" class="form-label">Distance Ayak ${ayakCount} (km):</label>
        <input type="number" id="distance_${ayakCount}" name="distance_${ayakCount}" class="form-control" step="any" required>
      </div>
      <div class="col-sm-6">
        <label for="distance_eca_${ayakCount}" class="form-label">Distance ECA Ayak ${ayakCount} (km):</label>
        <input type="number" id="distance_eca_${ayakCount}" name="distance_eca_${ayakCount}" class="form-control" step="any" required>
      </div>
      <div class="col-sm-6">
        <label for="port_day_${ayakCount}" class="form-label">Port Day Ayak ${ayakCount} (gün):</label>
        <input type="number" id="port_day_${ayakCount}" name="port_day_${ayakCount}" class="form-control" step="any" required>
      </div>
      <div class="col-sm-6">
        <label for="port_fuel_${ayakCount}" class="form-label">Port Yakıt Ayak ${ayakCount}:</label>
        <select id="port_fuel_${ayakCount}" name="port_fuel_${ayakCount}" class="form-control" required>${generateOptions(fuelData)}</select>
      </div>
      <div class="col-sm-6">
        <label for="sea_fuel_${ayakCount}" class="form-label">Sea Yakıt Ayak ${ayakCount}:</label>
        <select id="sea_fuel_${ayakCount}" name="sea_fuel_${ayakCount}" class="form-control" required>${generateOptions(fuelData)}</select>
      </div>
      <div class="col-sm-6">
        <label for="eca_fuel_${ayakCount}" class="form-label">ECA Sea Yakıt Ayak ${ayakCount}:</label>
        <select id="eca_fuel_${ayakCount}" name="eca_fuel_${ayakCount}" class="form-control" required>${generateOptions(fuelData)}</select>
      </div>
    `;
    ayakInputs.appendChild(newAyak);
    document.getElementById(`from_${ayakCount}`).value = previousTo;
  }

  function generateOptions(data) {
    return data.map(item => `<option value="${item.port || item.Pathway_Name}">${item.port || item.Pathway_Name}</option>`).join("");
  }

  document.addEventListener("DOMContentLoaded", () => {
    fetch("/rota_data")
      .then(response => response.json())
      .then(data => {
        rotaData = data;
        fillInitialAyak();
      })
      .catch(err => console.error("Liman verileri alınırken hata oluştu:", err));

    fetch("/fuel_data")
      .then(response => response.json())
      .then(data => {
        fuelData = data;
        fillInitialAyak();
      })
      .catch(err => console.error("Yakıt verileri alınırken hata oluştu:", err));
  });

  function fillInitialAyak() {
    if (rotaData.length > 0 && fuelData.length > 0) {
      document.getElementById("from_1").innerHTML = generateOptions(rotaData);
      document.getElementById("to_1").innerHTML = generateOptions(rotaData);
      document.getElementById("port_fuel_1").innerHTML = generateOptions(fuelData);
      document.getElementById("sea_fuel_1").innerHTML = generateOptions(fuelData);
      document.getElementById("eca_fuel_1").innerHTML = generateOptions(fuelData);
    }
  }

  seferForm.addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(seferForm);
    const formObject = Object.fromEntries(formData.entries());

    fetch('/sefer-kaydet', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formObject)
    })
    .then(response => {
      if (response.ok) {
        return response.text();
      }
      throw new Error("Kayıt işlemi sırasında hata oluştu.");
    })
    .then(message => {
      alert(message);
      seferForm.reset();
      window.location.reload();
    })
    .catch(error => {
      alert(error.message);
    });
  });

</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>
